<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ë‚¨ê·œì˜ PDF í…ìŠ¤íŠ¸ ì¶”ì¶œê¸° (Raw Text)</title>
    <link rel="stylesheet" href="./main.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <script>
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js";
    </script>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“„ PDF â†’ í…ìŠ¤íŠ¸(TXT) ë³€í™˜ê¸°</h1>
      <p class="desc">
        ë³µì¡í•œ ê°€ê³µ ì—†ì´ PDFì˜ <b>ëª¨ë“  ê¸€ì</b>ë¥¼ í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
      </p>

      <div class="upload-box">
        <input
          type="file"
          id="pdfInput"
          multiple
          accept="application/pdf"
          style="display: none"
          onchange="handleFiles(this.files)"
        />
        <label
          for="pdfInput"
          style="cursor: pointer; font-size: 18px; font-weight: bold"
        >
          í´ë¦­í•´ì„œ PDF íŒŒì¼ ì„ íƒ (ì—¬ëŸ¬ ê°œ ê°€ëŠ¥)
        </label>
        <div
          id="fileCount"
          style="margin-top: 10px; color: #007bff; font-weight: bold"
        ></div>
      </div>

      <button id="convertBtn" onclick="processFiles()" disabled>
        í…ìŠ¤íŠ¸ íŒŒì¼ë¡œ ì €ì¥í•˜ê¸°
      </button>

      <div class="log-area" id="logArea">ëŒ€ê¸° ì¤‘...</div>
    </div>

    <script>
      function handleFiles(files) {
        document.getElementById("fileCount").innerText =
          `ì´ ${files.length}ê°œì˜ íŒŒì¼ì´ ì„ íƒë¨`;
        document.getElementById("convertBtn").disabled = false;
      }

      async function processFiles() {
        const input = document.getElementById("pdfInput");
        const log = document.getElementById("logArea");

        if (input.files.length === 0) return;

        log.innerHTML = "ì‘ì—… ì‹œì‘...";

        for (let file of input.files) {
          try {
            log.innerHTML += `<br>Processing: ${file.name}...`;

            // 1. PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
            const rawText = await extractTextFromPDF(file);

            // 2. í…ìŠ¤íŠ¸ íŒŒì¼(.txt)ë¡œ ë‹¤ìš´ë¡œë“œ
            downloadTextFile(file.name, rawText);

            log.innerHTML += ` <span style="color:green">ì™„ë£Œ!</span>`;
          } catch (e) {
            console.error(e);
            log.innerHTML += ` <span style="color:red">ì‹¤íŒ¨!</span>`;
          }
        }
        log.innerHTML += `<br><br><b>ëª¨ë“  ì‘ì—…ì´ ëë‚¬ìŠµë‹ˆë‹¤. ë‹¤ìš´ë¡œë“œ í´ë”ë¥¼ í™•ì¸í•˜ì„¸ìš”.</b>`;
      }

      // PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ í•¨ìˆ˜ (ê¾¸ë°ˆ ì—†ì´ ìˆœìˆ˜ í…ìŠ¤íŠ¸ë§Œ)
      async function extractTextFromPDF(file) {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        let fullText = `íŒŒì¼ëª…: ${file.name}\n-----------------------------------\n`;

        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();

          // í˜ì´ì§€ ë‚´ì˜ í…ìŠ¤íŠ¸ ì•„ì´í…œë“¤ì„ ê³µë°±ìœ¼ë¡œ ì—°ê²°
          // transform[5]ëŠ” yì¢Œí‘œì¸ë°, ì´ê±¸ë¡œ ì¤„ë°”ê¿ˆì„ ì™„ë²½íˆ êµ¬í˜„í•˜ê¸´ ì–´ë µì§€ë§Œ
          // ë‹¨ìˆœ í…ìŠ¤íŠ¸ ì¶”ì¶œìš©ìœ¼ë¡œëŠ” join(" ")ì´ë‚˜ join("\n")ì´ ìµœì„ ì…ë‹ˆë‹¤.
          const pageText = textContent.items.map((item) => item.str).join("  ");

          fullText += `[Page ${i}]\n${pageText}\n\n`;
        }
        return fullText;
      }

      // .txt íŒŒì¼ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜
      function downloadTextFile(filename, text) {
        const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);

        // í™•ì¥ìë¥¼ .pdf -> .txt ë¡œ ë³€ê²½
        const newFileName = filename.replace(".pdf", "") + "_ì¶”ì¶œë³¸.txt";

        link.setAttribute("href", url);
        link.setAttribute("download", newFileName);
        link.style.visibility = "hidden";
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    </script>
  </body>
</html>
